# AIstoic 実装計画書

## 1. プロジェクト概要

ポケモン第三世代のバトルシステムに基づいた、サンダー対メタグロスの1対1対戦シミュレーターを実装する。モンテカルロ法（10,000回シミュレーション）により、各条件下での勝率を算出する。

## 2. ディレクトリ構成

```
src/
├── types/               # 型定義
│   ├── pokemon.ts      # ポケモン関連の型
│   ├── battle.ts       # バトル関連の型
│   └── index.ts        # エクスポート
├── constants/          # 定数定義
│   ├── pokemon.ts      # 種族値、性格補正
│   ├── moves.ts        # 技データ
│   ├── items.ts        # 持ち物データ
│   └── index.ts        # エクスポート
├── utils/              # ユーティリティ関数
│   ├── stats.ts        # ステータス計算
│   ├── damage.ts       # ダメージ計算
│   ├── random.ts       # 乱数関連
│   └── index.ts        # エクスポート
├── services/           # ビジネスロジック
│   ├── battle.ts       # バトルシミュレーション
│   └── simulation.ts   # モンテカルロシミュレーション
├── components/         # UIコンポーネント
│   ├── ThunderForm/    # サンダー入力フォーム
│   ├── MetagrossForm/  # メタグロス入力フォーム
│   ├── ResultTable/    # 勝率結果テーブル
│   ├── StatsInput/     # ステータス入力コンポーネント（個体値・努力値）
│   └── Layout/         # レイアウト
├── hooks/              # カスタムフック
│   └── useSimulation.ts # シミュレーション実行フック
└── App.tsx             # メインコンポーネント
```

## 3. 実装フェーズ

### フェーズ1: 基盤構築（型定義・定数）

#### 3.1.1 型定義 (types/)
```typescript
// ポケモンのステータス
interface Stats {
  hp: number;
  attack: number;
  defense: number;
  spAttack: number;
  spDefense: number;
  speed: number;
}

// 個体値（0-31）
interface IVs {
  hp: number;
  attack: number;
  defense: number;
  spAttack: number;
  spDefense: number;
  speed: number;
}

// 努力値配分
interface EVs {
  hp: number;
  attack: number;
  defense: number;
  spAttack: number;
  spDefense: number;
  speed: number;
}

// 性格
type Nature = '...' // 25種類

// 持ち物
type Item = 'ラムのみ' | 'オボンのみ' | 'じしゃく' | 'ひかりのこな' | 'もちものなし' | 'せんせいのツメ' | 'こだわりハチマキ' | 'たべのこし';

// 技
interface Move {
  name: string;
  power: number;
  accuracy: number;
  additionalEffect?: {
    type: 'paralysis' | 'flinch';
    chance: number;
  };
}

// ポケモンデータ
interface Pokemon {
  species: 'サンダー' | 'メタグロス';
  level: number;
  nature: Nature;
  ivs: IVs;
  evs: EVs;
  item: Item;
  moves?: string[];
  stats?: Stats; // 計算後のステータス
}
```

#### 3.1.2 定数定義 (constants/)
- サンダーの種族値: { hp: 90, attack: 90, defense: 85, spAttack: 125, spDefense: 90, speed: 100 }
- メタグロスの種族値: { hp: 80, attack: 135, defense: 130, spAttack: 95, spDefense: 90, speed: 70 }
- 性格補正値
- 技データ（10まんボルト、かみなり、いわなだれ、ねむる）
- 持ち物効果

### フェーズ2: 計算ロジック実装

#### 3.2.1 ステータス計算 (utils/stats.ts)
- 第三世代の計算式に準拠
- HP: (種族値 * 2 + 個体値 + 努力値 / 4) * レベル / 100 + 10 + レベル
- その他: ((種族値 * 2 + 個体値 + 努力値 / 4) * レベル / 100 + 5) * 性格補正

#### 3.2.2 ダメージ計算 (utils/damage.ts)
- 第三世代の計算式に準拠
- 各種補正（タイプ一致、タイプ相性、持ち物、急所、乱数）を適用
- 小数点以下は各段階で切り捨て

### フェーズ3: バトルシミュレーション

#### 3.3.1 バトルロジック (services/battle.ts)
- ターン制バトルの実装
- 行動順決定（素早さ、麻痺、せんせいのツメ）
- 技の命中判定
- ダメージ処理
- 追加効果処理（麻痺、ひるみ）
- 持ち物効果処理
- ねむる使用条件の判定

#### 3.3.2 モンテカルロシミュレーション (services/simulation.ts)
- 10,000回のバトルシミュレーション実行
- Web Workerの使用を検討（パフォーマンス向上）
- 21パターンのメタグロスに対して並列実行

### フェーズ4: UI実装

#### 3.4.1 サンダー入力フォーム (components/ThunderForm/)
- 個体値入力（0-31、数値入力 or スライダー）
  - デフォルト値: 31（V）
  - 各ステータスごとに設定可能
- 努力値入力（スライダー or 数値入力）
  - 努力値合計510制限の実装
  - リアルタイムで残り振れる値を表示
- 性格選択（ドロップダウン）
  - 25種類の性格
  - ステータス補正をプレビュー表示
- 技選択（ラジオボタン）
  - 10まんボルト / かみなり
- ねむる採用チェックボックス
- 持ち物選択（ラジオボタン）

#### 3.4.2 メタグロス入力フォーム (components/MetagrossForm/)
- プリセット選択
  - 耐久調整型
  - いじっぱりHA
  - いじっぱりAS
  - カスタム（自由入力）
- カスタム入力モード
  - 個体値入力（デフォルト: 31）
  - 努力値入力（合計510制限）
  - 性格選択（主にいじっぱり、ようき等）
- 持ち物選択（7種類）
- プリセット選択時は自動で値が入力される

#### 3.4.3 結果テーブル (components/ResultTable/)
- 3x7のテーブル表示（プリセット3種）
- カスタムメタグロスの結果は別途表示
- 勝率に応じた色分け（高勝率: 緑、低勝率: 赤）
- ローディング状態の表示
- 結果のソート機能（オプション）

#### 3.4.4 レスポンシブデザイン
- モバイル対応（テーブルのスクロール）
- タブレット・デスクトップでの最適表示

### フェーズ5: パフォーマンス最適化

#### 3.5.1 計算の最適化
- メモ化（React.memo, useMemo）
- 定数の事前計算
- 不要な再レンダリングの防止

#### 3.5.2 並列処理
- Web Workerによるシミュレーション並列化
- プログレスバーの実装

## 4. 実装優先順位

1. **必須機能（MVP）**
   - 基本的なステータス・ダメージ計算
   - シンプルなバトルシミュレーション
   - 基本的な入力フォーム
   - 結果表示

2. **追加機能**
   - 詳細な確率計算
   - アニメーション
   - 結果の保存・共有機能
   - 詳細ログ表示

## 5. テスト計画

### 5.1 ユニットテスト
- ステータス計算のテスト
- ダメージ計算のテスト
- 各種確率計算のテスト

### 5.2 統合テスト
- バトルシミュレーションのテスト
- 既知の結果との照合

### 5.3 E2Eテスト（オプション）
- ユーザー操作フローのテスト

## 6. 技術的な考慮事項

### 6.1 UIフレームワーク
- shadcn/ui を採用（Radix UI + Tailwind CSS）
- アクセシビリティと一貫性のあるデザインを実現

### 6.2 フォーム管理（React 19のベストプラクティス）
- useActionState を使用したフォーム状態管理
- サーバーアクション風の設計（クライアントサイドで完結）
- Zodによるスキーマバリデーション
- react-hook-form との統合

### 6.3 状態管理
- フォーム状態: useActionState + useOptimistic
- グローバル状態: 必要に応じてContext APIまたはZustand
- 計算結果のキャッシュ: useMemo

### 6.4 スタイリング
- Tailwind CSS v4 + shadcn/ui のテーマシステム
- CSS変数によるテーマカスタマイズ
- レスポンシブデザイン

### 6.5 型安全性
- 厳格な型定義
- anyの使用禁止
- 型ガードの活用
- Zodスキーマからの型推論

## 7. 実装スケジュール（目安）

1. フェーズ1: 基盤構築 - 1時間
2. フェーズ2: 計算ロジック - 2時間
3. フェーズ3: バトルシミュレーション - 3時間
4. フェーズ4: UI実装 - 2時間
5. フェーズ5: 最適化・テスト - 1時間

合計: 約9時間

## 8. リスクと対策

### 8.1 パフォーマンス
- リスク: 10,000回のシミュレーションが重い
- 対策: Web Worker、段階的な結果表示

### 8.2 計算精度
- リスク: 第三世代の仕様の細かい部分
- 対策: 既存の計算機との照合、コミュニティ知識の活用

### 8.3 ブラウザ互換性
- リスク: 古いブラウザでの動作
- 対策: 最新ブラウザのみサポート（GitHub Pages前提）